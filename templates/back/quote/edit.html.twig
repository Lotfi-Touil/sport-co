{% extends 'base.html.twig' %}

{% block title %}Modifier un devis{% endblock %}

{% block body %}
   {% include '_partials/back/_platform_nav.html.twig' %}

    <section class="p-4 mt-14 w-full">
        <div id="flash-messages" class="fixed bottom-4 mb-4 right-4 z-50 flex flex-col space-y-2">
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="flash-message {{ label == 'success' ? 'bg-green-500 text-white' : '' }}
                                {{ label == 'error' ? 'bg-red-500 text-white' : '' }}
                                px-4 py-2 rounded shadow-md relative" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>

        <div class="actions flex justify-end">
            <a href="{{ path('platform_quote_index') }}" class="inline-block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                Revenir à la liste
            </a>
            {{ include('back/quote/_delete_form.html.twig') }}
        </div>

        <div class="max-w-5xl ml-10 py-16 bg-white">
            <article class="overflow-hidden">
                <div class="bg-[white] rounded-b-md">
                    <div class="pl-9 pb-9">
                        <div class="space-y-6 text-slate-700">
                            <p class="text-xl font-extrabold tracking-tight uppercase font-body">
                                Devis #{{ quote.id }}
                            </p>
                        </div>
                    </div>
                    <div class="pl-9 pb-9">
                        <div class="flex w-full">
                            <div class="grid grid-cols-4 gap-12">
                                <div class="text-sm font-light text-slate-500">
                                    <p class="text-sm font-normal text-slate-700">
                                    Details
                                    </p>
                                    <p>Unwrapped</p>
                                    <p>Fake Street 123 San Javier CA 1234</p>
                                </div>
                                <div id="bloc-destinataire" class="text-sm font-light text-slate-500">
                                    <p class="text-sm font-normal text-slate-700">Destinataire</p>
                                    {% set hiddenClass = quote.quoteUsers.isEmpty() ? 'hidden' : '' %}
                                    <button id="remove-customer" class="bg-red-500 hover:bg-red-700 text-white font-bold px-2 my-1 rounded {{ hiddenClass }}">
                                        Retirer
                                    </button>
                                    <div class="zone-info-dest">
                                    {% if quote.quoteUsers is not empty %}
                                        {% set quoteUser = quote.quoteUsers[0] %}
                                        <input id="user-dest-id" type="hidden" value="{{ quoteUser.customer.id }}" class="hidden"/>
                                        <p class="user-dest-intitule disabled">{{ quoteUser.customer.firstName }} {{ quoteUser.customer.lastName }}</p>
                                        <p class="user-dest-email disabled">{{ quoteUser.customer.email }}</p>
                                        <p class="user-dest-address-street disabled">Adresse</p>
                                    {% else %}
                                        <p>-</p>
                                        <p>-</p>
                                        <p>-</p>
                                    {% endif %}
                                    </div>
                                </div>
                                <div class="text-sm font-light text-slate-500">
                                    <p class="text-sm font-normal text-slate-700">Numéro de devis</p>
                                    <p>{{ quote.id }}</p>
                                    <p class="mt-2 text-sm font-normal text-slate-700">
                                    Date of délivrance
                                    </p>
                                    <p>00.00.00</p>
                                </div>
                                <div class="text-sm font-light text-slate-500">
                                    <p class="text-sm font-normal text-slate-700">Validité</p>
                                    <p>0 Days</p>
                                    <p class="mt-2 text-sm font-normal text-slate-700">TODO</p>
                                    <p>00.00.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pl-9 mt-5">
                        <div class="flex justify-between mb-2">
                            <label class="block text-gray-700 text-sm font-bold">
                                Affecter le devis à :
                            </label>
                            <span id="warning-customer-delete" class="font-bold text-red-500">{{ quote.quoteUsers is not empty ? "(Attention: le destinataire actuel sera détaché du devis)" : '' }}</span>
                        </div>
                        <form>
                            <label for="user-search" class="text-sm font-medium text-gray-900 sr-only">Rechercher un client</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"></div>
                                <input type="search" id="user-search" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" placeholder="Tapez pour rechercher un utilisateur" required>
                                <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">Rechercher</button>
                            </div>
                        </form>
                        <div id="user-results" class="mt-2 bg-gray-50 p-4 rounded shadow-inner hidden">
                            <!-- résultats -->
                        </div>
                    </div>

                    <div class="pl-9 mt-5">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ajouter un produit</label>
                        <form>
                            <label for="product-search" class="text-sm font-medium text-gray-900 sr-only">Rechercher un produit</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"></div>
                                <input type="search" id="product-search" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" placeholder="Rechercher un produit" required>
                                <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">Rechercher</button>
                            </div>
                        </form>
                        <div id="product-results" class="mt-2 bg-gray-50 p-4 rounded shadow-inner hidden">
                            <!-- résultats -->
                        </div>
                    </div>

                    <div class="pl-9 pb-9">
                        <div class="flex flex-col mx-0 mt-8">
                            <table class="min-w-full divide-y divide-slate-500">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-normal text-slate-700 sm:pl-6 md:pl-0">
                                            Produit
                                        </th>
                                        <th scope="col" class="hidden py-3.5 px-3 text-right text-sm font-normal text-slate-700 sm:table-cell">
                                            Quantité
                                        </th>
                                        <th scope="col" class="hidden py-3.5 px-3 text-right text-sm font-normal text-slate-700 sm:table-cell">
                                            Taxe (%)
                                        </th>
                                        <th scope="col" class="hidden py-3.5 px-3 text-right text-sm font-normal text-slate-700 sm:table-cell">
                                            Taxe (€)
                                        </th>
                                        <th scope="col" class="py-3.5 pl-3 pr-4 text-right text-sm font-normal text-slate-700 sm:pr-6 md:pr-0">
                                            Prix HT
                                        </th>
                                        <th scope="col" class="py-3.5 pl-3 pr-4 text-right text-sm font-normal text-slate-700 sm:pr-6 md:pr-0">
                                            Prix TTC
                                        </th>
                                        <th scope="col" class="py-3.5 pl-3 pr-4 text-right text-sm font-normal text-slate-700 sm:pr-6 md:pr-0">
                                            Total
                                        </th>
                                        <th scope="col" class="py-3.5 pl-3 pr-4 text-right text-sm font-normal text-slate-700 sm:pr-6 md:pr-0">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="added-products">
                                    {% for quoteProduct in quote.quoteProducts %}
                                        {% set tax_amount = (quoteProduct.price * quoteProduct.taxRate / 100) | round(2) %}
                                        <tr class="product-info border-b border-slate-200"  data-product-id="{{ quoteProduct.product.id }}">
                                            <input type="hidden" class="product-item form-input mt-1 block w-16 text-center"
                                                   value="{{ quoteProduct.quantity }}" min="1"
                                                   data-product-id="{{ quoteProduct.product.id }}"
                                                   data-product-price="{{ quoteProduct.price }}"
                                                   data-product-tax-rate="{{ quoteProduct.taxRate }}">
                                            <td class="py-4 pl-4 pr-3 text-sm sm:pl-6 md:pl-0">
                                                <div class="font-medium text-slate-700">{{ quoteProduct.product.name }}</div>
                                            </td>
                                            <td class="hidden px-3 py-4 text-sm text-right text-slate-500 sm:table-cell">
                                                <div>
                                                    <button class="decrement-quantity bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-4 rounded">-</button>
                                                    <span class="quantity-display mx-2">{{ quoteProduct.quantity }}</span>
                                                    <button class="increment-quantity bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-4 rounded">+</button>
                                                </div>
                                            </td>
                                            <td class="py-4 pl-3 pr-4 text-sm text-right text-slate-500 sm:pr-6 md:pr-0">
                                                {{ quoteProduct.taxRate }}% 
                                            </td>
                                            <td class="py-4 pl-3 pr-4 text-sm text-right text-slate-500 sm:pr-6 md:pr-0">
                                                {{ tax_amount }} € 
                                            </td>
                                            <td class="hidden px-3 py-4 text-sm text-right text-slate-500 sm:table-cell">
                                                {{ quoteProduct.price - tax_amount | number_format(2, '.', '') }} €
                                            </td>
                                            <td class="hidden px-3 py-4 text-sm text-right text-slate-500 sm:table-cell">
                                                {{ (quoteProduct.price) | number_format(2, '.', '') }} €
                                            </td>
                                            {% set total_item_price = (quoteProduct.price * quoteProduct.quantity) | round(2) %}
                                            <td class="total-product-price hidden px-3 py-4 text-sm text-right text-slate-500 sm:table-cell">
                                                {{ total_item_price | number_format(2, '.', '') }} €
                                            </td>
                                            <td class="hidden text-sm text-right text-slate-500 sm:table-cell">
                                                <button class="remove-product bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                                                        data-product-id="{{ quoteProduct.product.id }}"
                                                >Retirer</button>
                                            </td>
                                        </tr>
                                    {% else %}
                                        <tr class="py-5" id="no-products">
                                            <td class="py-2" colspan="7">Le devis ne contient aucun article.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th scope="row" colspan="7" class="hidden pt-6 pl-6 pr-3 text-sm font-light text-right text-slate-500 sm:table-cell md:pl-0">
                                            Sous-total
                                        </th>
                                        <th scope="row" class="pt-6 pl-4 pr-3 text-sm font-light text-left text-slate-500 sm:hidden">
                                            Total
                                        </th>
                                        <td id="subtotal" class="pt-6 pl-3 pr-4 text-sm text-right text-slate-500 sm:pr-6 md:pr-0">
                                            {{ quote.subtotal|default('-')|number_format(2, ',', ' ') }} €
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="7" class="hidden pt-6 pl-6 pr-3 text-sm font-light text-right text-slate-500 sm:table-cell md:pl-0">
                                            Remise
                                        </th>
                                        <th scope="row" class="pt-6 pl-4 pr-3 text-sm font-light text-left text-slate-500 sm:hidden">
                                            Remise
                                        </th>
                                        <td id="total-remise" class="pt-6 pl-3 pr-4 text-sm text-right text-slate-500 sm:pr-6 md:pr-0">
                                            0.00 €
                                            {# TODO #}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="7" class="hidden pt-4 pl-6 pr-3 text-sm font-light text-right text-slate-500 sm:table-cell md:pl-0">
                                            Taxe
                                        </th>
                                        <th scope="row" class="pt-4 pl-4 pr-3 text-sm font-light text-left text-slate-500 sm:hidden">
                                            Taxe
                                        </th>
                                        <td id="total-taxes" class="pt-4 pl-3 pr-4 text-sm text-right text-slate-500 sm:pr-6 md:pr-0">
                                            {{ quote.totalAmount - quote.subtotal | number_format(2, '.', '') }} €
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="7" class="hidden pt-4 pl-6 pr-3 text-sm font-normal text-right text-slate-700 sm:table-cell md:pl-0">
                                            Total
                                        </th>
                                        <th scope="row" class="pt-4 pl-4 pr-3 text-sm font-normal text-left text-slate-700 sm:hidden">
                                            Total
                                        </th>
                                        <td id="total-amount" class="pt-4 pl-3 pr-4 text-sm font-normal text-right text-slate-700 sm:pr-6 md:pr-0">
                                            {{ quote.totalAmount|default('-')|number_format(2, ',', ' ') }} €
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div>
                            {{ form_start(form, {'attr': {'id': 'form-new-quote', 'class': 'w-full'}}) }}

                            {% if form.vars.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {% for error in form.vars.errors %}
                                        <p>{{ error.message }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Statut</label>
                                {{ form_widget(form.quoteStatus, {'attr': {'class': 'border-gray-300 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline'}}) }}
                                {{ form_errors(form.quoteStatus) }}
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Notes et observations</label>
                                {{ form_widget(form.notes, {'attr': {'class': 'border-gray-300 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline'}}) }}
                                {{ form_errors(form.notes) }}
                            </div>

                            <input type="hidden" id="form_products_json" name="form[products_json]" value="">

                            <input type="hidden" id="form_customer_json" name="form[customer_json]" value="">

                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                {{ button_label|default('Enregistrer') }}
                            </button>

                            {{ form_end(form) }}
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>

   {% include '_components/back/js/quote-and-invoice-script.html.twig' %}

{% endblock %}

{% extends 'base.html.twig' %}

{% block title %}Tableau de Bord des Paiements
{% endblock %}

{% block body %}
	{% include '_partials/back/_platform_nav.html.twig' %}
	<div class="flex flex-col md:flex-row min-h-screen pt-20 w-full">
		<div class="w-full px-4">
			<div x-data="{ open: false, selectedInvoiceId: null }">
				<div class="flex justify-between items-center mb-4">
					<h1 class="text-xl font-bold mb-4 md:mb-0">Tableau de Bord des Paiements</h1>
					<!-- Bouton pour ouvrir le formulaire modal -->
					<button @click="open = true" class="block text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">

						Créer un Paiement
					</button>
				</div>

				<div class="overflow-x-auto bg-white rounded shadow">
					<table class="min-w-full leading-normal">
						<thead>
							<tr>
								<th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
									ID
								</th>
								<th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
									Montant
								</th>
								<th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
									Statut
								</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
									Payer
								</th>
							</tr>
						</thead>
						<tbody>
							{% if payments is not empty %}
								{% for payment in payments %}
									<tr>
										<td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
											{{ payment.id }}
										</td>
										<td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
											{{ payment.amount }}
										</td>
										<td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
											{{ payment.paymentStatus.name }}
										</td>
										<td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
											<a href="{{ path('payment_checkout', {'paymentId': payment.id}) }}" class="text-blue-600 hover:text-blue-900">Payer</a>
										</td>
									</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="3" class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
										Aucun paiement trouvé.
									</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
				<div x-show="open" @click.away="open = false" class="fixed inset-0 z-50 flex items-center justify-center overflow-auto">
					<div class="fixed inset-0 bg-black opacity-50"></div>
					<div
						class="relative p-4 w-full max-w-md max-h-full">
						<!-- Modal content -->
						<div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
							<!-- Modal header -->
							<div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
								<h3 class="text-lg font-semibold text-gray-900 dark:text-white">
									Créer un Paiement
								</h3>
								<button @click="open = false" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm h-8 w-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
									<svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 14 14">
										<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
									</svg>
									<span class="sr-only">Close modal</span>
								</button>
							</div>
							<!-- Modal body and rest of your modal content... -->
							<div
								class="p-4 md:p-5">
								<!-- Corps du Modal -->
								<form id="paymentForm">
									<ul class="space-y-4 mb-4">
										{% for invoice in invoices %}
											<li>
												<input type="radio" id="invoice-{{ invoice.id }}" name="invoice" value="{{ invoice.id }}" class="hidden peer" @change="selectedInvoiceId = {{ invoice.id }}">
												<label for="invoice-{{ invoice.id }}" class="inline-flex items-center justify-between w-full p-5 text-gray-900 bg-white border border-gray-200 rounded-lg cursor-pointer peer-checked:bg-blue-100">
													<div class="block">
														<div class="w-full text-lg font-semibold">{{ invoice.id }}</div>
														<div class="w-full text-gray-500 dark:text-gray-400">{{ invoice.totalAmount }}</div>
													</div>
												</label>
											</li>
										{% else %}
											<li>Aucune facture disponible.</li>
										{% endfor %}
									</ul>
									<div class="mb-4">
										<label for="payment-type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">Type de Paiement :</label>
										<select id="payment-type" name="payment_type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
											<option value="unique">Paiement Unique</option>
											<option value="recurring">Paiement Récurrent</option>
										</select>
									</div>
									<div id="error-message" class="hidden text-red-500 text-sm mt-2"></div>
									<button type="button" onclick="submitPaymentForm()" class="text-white inline-flex w-full justify-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
										Créer le Paiement
									</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
<script>
    function submitPaymentForm() {
        var selectedInvoiceId = document.querySelector('input[name="invoice"]:checked');
        var paymentType = document.getElementById('payment-type').value;
        var errorMessage = document.getElementById('error-message');

        // Réinitialiser le message d'erreur
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';

        // Validation
        if (!selectedInvoiceId || !paymentType) {
            errorMessage.textContent = 'Veuillez sélectionner une facture et un type de paiement.';
            errorMessage.classList.remove('hidden');
            return;
        }

        fetch('/platform/payment/create/' + selectedInvoiceId.value, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ payment_type: paymentType })
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                console.error('Erreur lors de la création du paiement');
            }
        }).catch(error => {
            console.error('Erreur AJAX : ', error);
        });
    }
</script>
{% endblock %}
